<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简历生成器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: row; margin: 0; background-color: #f0f2f5; color: #333; min-height: 100vh; }
        .form-container { flex: 1; padding: 30px; overflow-y: auto; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .preview-container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        h1, h2 { color: #333; }
        h1 { text-align: center; margin-bottom: 20px;}
        fieldset { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; }
        legend { font-weight: bold; color: #007bff; padding: 0 5px;}
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="email"], input[type="tel"], select, textarea {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        textarea { min-height: 80px; resize: vertical; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top:10px;}
        button:hover { background-color: #0056b3; }
        .action-buttons { text-align: center; margin-top: 20px; }
        .status-message { margin-top: 15px; text-align: center; font-weight: bold; }
        .error { color: red; }
        .success { color: green; }
        .dynamic-section .entry { border: 1px dashed #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #f9f9f9;}
        .remove-btn { background-color: #dc3545; font-size: 12px; padding: 5px 10px; margin-top: 5px;}
        .remove-btn:hover { background-color: #c82333; }
        #resumePreview { width: 100%; height: 600px; border: 1px solid #ccc; background-color: #fff; }
        .template-selector-container { margin-bottom: 20px; text-align: center; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js"></script>
</head>
<body>
    <div class="form-container">
        <h1>简历信息填写</h1>

        <div class="template-selector-container">
            <label for="templateSelector">选择简历模板:</label>
            <select id="templateSelector">
                </select>
        </div>

        <fieldset>
            <legend>个人信息</legend>
            <label for="name">姓名:</label>
            <input type="text" id="name" name="name" value="王小明">
            <label for="email">邮箱:</label>
            <input type="email" id="email" name="email" value="wangxiaoming@example.com">
            <label for="phone">电话:</label>
            <input type="tel" id="phone" name="phone" value="13612345678">
            <label for="linkedin">LinkedIn (可选, e.g., linkedin.com/in/username):</label>
            <input type="text" id="linkedin" name="linkedin" value="linkedin.com/in/wangxiaoming">
        </fieldset>

        <fieldset class="dynamic-section">
            <legend>教育背景</legend>
            <div id="educationEntries">
                </div>
            <button type="button" id="addEducationBtn">添加教育经历</button>
        </fieldset>

        <fieldset class="dynamic-section">
            <legend>工作经历</legend>
            <div id="experienceEntries">
                </div>
            <button type="button" id="addExperienceBtn">添加工作经历</button>
        </fieldset>

        <fieldset class="dynamic-section">
            <legend>技能 (每行一个技能)</legend>
            <textarea id="skills" name="skills" placeholder="例如:&#10;JavaScript&#10;Python&#10;React">HTML5\nCSS3\nJavaScript (ES6+)\nNode.js\n沟通能力</textarea>
        </fieldset>

        <div class="action-buttons">
            <button id="previewBtn">实时预览</button>
            <button id="generateBtn">生成并下载PDF</button>
        </div>
        <div id="statusMessage" class="status-message"></div>
    </div>

    <div class="preview-container">
        <h2>简历预览</h2>
        <iframe id="resumePreview" title="Resume Preview"></iframe>
    </div>

    <script>
        // Store client-side template strings (fetched or embedded)
        const clientTemplates = {};

        // --- DOM Elements ---
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const linkedinInput = document.getElementById('linkedin');

        const educationEntriesContainer = document.getElementById('educationEntries');
        const addEducationBtn = document.getElementById('addEducationBtn');

        const experienceEntriesContainer = document.getElementById('experienceEntries');
        const addExperienceBtn = document.getElementById('addExperienceBtn');

        const skillsTextarea = document.getElementById('skills');

        const templateSelector = document.getElementById('templateSelector');
        const previewBtn = document.getElementById('previewBtn');
        const generateBtn = document.getElementById('generateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const resumePreviewFrame = document.getElementById('resumePreview');

        // --- Dynamic Section Counters ---
        let educationCount = 0;
        let experienceCount = 0;

        // --- Populate Template Selector ---
        async function populateTemplateSelector() {
            try {
                const response = await fetch('/api/templates');
                if (!response.ok) throw new Error('Failed to fetch templates');
                const templates = await response.json();
                templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.displayName;
                    templateSelector.appendChild(option);

                    // Fetch and store template HTML for client-side preview
                    fetch(`/templates/${template.id}.hbs`)
                        .then(res => res.text())
                        .then(html => {
                            clientTemplates[template.id] = Handlebars.compile(html);
                        })
                        .catch(err => console.error(`Failed to load template ${template.id} for preview:`, err));
                });
                if (templates.length > 0) {
                     // Trigger initial preview with the first template once it's loaded
                    const firstTemplateId = templates[0].id;
                    const checkFirstTemplateLoaded = setInterval(() => {
                        if (clientTemplates[firstTemplateId]) {
                            clearInterval(checkFirstTemplateLoaded);
                            updatePreview();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error populating template selector:', error);
                statusMessage.textContent = '无法加载模板列表。';
                statusMessage.className = 'status-message error';
            }
        }


        // --- Event Listeners for Dynamic Sections ---
        addEducationBtn.addEventListener('click', () => {
            educationCount++;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry education-entry';
            entryDiv.id = `edu-${educationCount}`;
            entryDiv.innerHTML = `
                <h4>教育经历 #${educationCount}</h4>
                <label for="school-${educationCount}">学校名称:</label>
                <input type="text" id="school-${educationCount}" name="school" value="XX大学">
                <label for="degree-${educationCount}">学位:</label>
                <input type="text" id="degree-${educationCount}" name="degree" value="学士">
                <label for="major-${educationCount}">专业:</label>
                <input type="text" id="major-${educationCount}" name="major" value="计算机科学">
                <label for="eduStartDate-${educationCount}">开始日期 (YYYY-MM):</label>
                <input type="text" id="eduStartDate-${educationCount}" name="startDate" value="2020-09">
                <label for="eduEndDate-${educationCount}">结束日期 (YYYY-MM):</label>
                <input type="text" id="eduEndDate-${educationCount}" name="endDate" value="2024-06">
                <button type="button" class="remove-btn" onclick="removeEntry('edu-${educationCount}')">移除</button>
            `;
            educationEntriesContainer.appendChild(entryDiv);
            addChangeListenersToInputs();
        });

        addExperienceBtn.addEventListener('click', () => {
            experienceCount++;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry experience-entry';
            entryDiv.id = `exp-${experienceCount}`;
            entryDiv.innerHTML = `
                <h4>工作经历 #${experienceCount}</h4>
                <label for="company-${experienceCount}">公司名称:</label>
                <input type="text" id="company-${experienceCount}" name="company" value="YY公司">
                <label for="position-${experienceCount}">职位:</label>
                <input type="text" id="position-${experienceCount}" name="position" value="软件工程师实习">
                <label for="expStartDate-${experienceCount}">开始日期 (YYYY-MM):</label>
                <input type="text" id="expStartDate-${experienceCount}" name="startDate" value="2023-07">
                <label for="expEndDate-${experienceCount}">结束日期 (YYYY-MM):</label>
                <input type="text" id="expEndDate-${experienceCount}" name="endDate" value="2023-12">
                <label for="responsibilities-${experienceCount}">职责 (每行一个):</label>
                <textarea id="responsibilities-${experienceCount}" name="responsibilities">项目A开发\nBUG修复</textarea>
                <button type="button" class="remove-btn" onclick="removeEntry('exp-${experienceCount}')">移除</button>
            `;
            experienceEntriesContainer.appendChild(entryDiv);
            addChangeListenersToInputs();
        });

        function removeEntry(entryId) {
            const entryElement = document.getElementById(entryId);
            if (entryElement) {
                entryElement.remove();
                updatePreview(); // Update preview after removing an entry
            }
        }

        // --- Data Collection ---
        function getResumeData() {
            const education = [];
            document.querySelectorAll('#educationEntries .education-entry').forEach(entry => {
                education.push({
                    school: entry.querySelector('[name="school"]').value,
                    degree: entry.querySelector('[name="degree"]').value,
                    major: entry.querySelector('[name="major"]').value,
                    startDate: entry.querySelector('[name="startDate"]').value,
                    endDate: entry.querySelector('[name="endDate"]').value,
                });
            });

            const experience = [];
            document.querySelectorAll('#experienceEntries .experience-entry').forEach(entry => {
                experience.push({
                    company: entry.querySelector('[name="company"]').value,
                    position: entry.querySelector('[name="position"]').value,
                    startDate: entry.querySelector('[name="startDate"]').value,
                    endDate: entry.querySelector('[name="endDate"]').value,
                    responsibilities: entry.querySelector('[name="responsibilities"]').value.split('\n').filter(line => line.trim() !== '')
                });
            });

            const skills = skillsTextarea.value.split('\n').filter(skill => skill.trim() !== '');

            return {
                personalInfo: {
                    name: nameInput.value,
                    email: emailInput.value,
                    phone: phoneInput.value,
                    linkedin: linkedinInput.value,
                },
                education,
                experience,
                skills
            };
        }

        // --- Real-time Preview ---
        function updatePreview() {
            const data = getResumeData();
            const selectedTemplateId = templateSelector.value;

            if (clientTemplates[selectedTemplateId]) {
                try {
                    const compiledHtml = clientTemplates[selectedTemplateId](data);
                    resumePreviewFrame.srcdoc = compiledHtml; // Set iframe content
                } catch (e) {
                    console.error("Error rendering client-side template:", e);
                    resumePreviewFrame.srcdoc = "<p>Error rendering preview.</p>";
                }
            } else {
                 // Fallback or loading message if template not yet loaded
                resumePreviewFrame.srcdoc = "<p>Loading template or template not available for preview...</p>";
                 // Attempt to fetch if not loaded - this might be redundant if populateTemplateSelector works
                if (selectedTemplateId && !clientTemplates[selectedTemplateId]) {
                    fetch(`/templates/${selectedTemplateId}.hbs`)
                        .then(res => res.text())
                        .then(html => {
                            clientTemplates[selectedTemplateId] = Handlebars.compile(html);
                            updatePreview(); // Retry preview update
                        });
                }
            }
        }

        previewBtn.addEventListener('click', updatePreview);

        // --- Generate PDF ---
        generateBtn.addEventListener('click', async () => {
            const resumeData = getResumeData();
            const selectedTemplateId = templateSelector.value;

            statusMessage.textContent = '正在生成PDF，请稍候...';
            statusMessage.className = 'status-message';

            try {
                const response = await fetch('/generate-resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resumeData, templateName: selectedTemplateId })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `${selectedTemplateId}-resume.pdf`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                        if (filenameMatch && filenameMatch.length === 2) filename = filenameMatch[1];
                    }
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    statusMessage.textContent = 'PDF生成成功并已开始下载！';
                    statusMessage.className = 'status-message success';
                } else {
                    const errorText = await response.text();
                    statusMessage.textContent = `错误：无法生成PDF (${response.status}) - ${errorText}`;
                    statusMessage.className = 'status-message error';
                }
            } catch (error) {
                statusMessage.textContent = '请求失败，请检查网络连接或服务器状态。';
                statusMessage.className = 'status-message error';
            }
        });

        // --- Initial Setup ---
        function addChangeListenersToInputs() {
            document.querySelectorAll('.form-container input, .form-container textarea, .form-container select').forEach(input => {
                input.removeEventListener('input', updatePreview); // Remove old listener to prevent duplicates
                input.addEventListener('input', updatePreview);
            });
        }

        // Initial population & setup
        populateTemplateSelector().then(() => {
            // Add default entries for better UX
            addEducationBtn.click();
            addExperienceBtn.click();
            addChangeListenersToInputs(); // Add listeners to initially present fields
        });
        templateSelector.addEventListener('change', updatePreview); // Update preview when template changes

    </script>
</body>
</html>